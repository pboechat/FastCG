#include "BumpMappingApplication.h"
#include <StandardGeometries.h>
#include <Material.h>
#include <OpenGLExceptions.h>
#include <PNGLoader.h>

#include <iostream>

BumpMappingApplication::BumpMappingApplication() :
	Application("bumpmapping", 800, 600)
{
	mClearColor = glm::vec4(1.0f, 1.0f, 1.0f, 1.0f);
	mMainCamera.Translate(glm::vec3(0, 50.0f, 90.0f));
}

BumpMappingApplication::~BumpMappingApplication()
{
}

void BumpMappingApplication::OnStart()
{
	LightPtr lightPtr = new Light();
	lightPtr->SetDiffuseColor(glm::vec4(0.8f, 0.8f, 0.8f, 1.0f));
	lightPtr->Translate(glm::vec3(0.0f, 20.0f, 0.0f));
	AddLight(lightPtr);

#ifdef USE_OPENGL4
	mBumpedDiffuseShaderPtr = new Shader("BumpedDiffuse");
	mBumpedDiffuseShaderPtr->Compile("shaders/BumpedDiffuse.vert", ST_VERTEX);
	mBumpedDiffuseShaderPtr->Compile("shaders/BumpedDiffuse.frag", ST_FRAGMENT);
	mBumpedDiffuseShaderPtr->Link();
#endif

	mGrassColorMapTexturePtr = LoadPNGAsTexture("textures/GrassColorMap.png");
	CHECK_FOR_OPENGL_ERRORS();
	mGrassBumpMapTexturePtr = LoadPNGAsTexture("textures/GrassBumpMap.png");
	CHECK_FOR_OPENGL_ERRORS();
	mTennisBallColorMapTexturePtr = LoadPNGAsTexture("textures/TennisBallColorMap.png");
	CHECK_FOR_OPENGL_ERRORS();
	mTennisBallBumpMapTexturePtr = LoadPNGAsTexture("textures/TennisBallBumpMap.png");
	CHECK_FOR_OPENGL_ERRORS();

	MaterialPtr groundMaterialPtr;

#ifdef USE_OPENGL4
	groundMaterialPtr = new Material(mBumpedDiffuseShaderPtr);
	groundMaterialPtr->SetTexture("colorMap", mGrassColorMapTexturePtr);
	//spGroundMaterial->SetTexture("bumpMap", mGrassBumpMapTexture);
	groundMaterialPtr->SetVec4("color", glm::vec4(1.0f, 1.0f, 1.0f, 1.0f));
#else
	groundMaterialPtr = new Material();

#endif

	GeometryPtr groundPtr = StandardGeometries::CreateXZPlane(100, 100, 1, 1, glm::vec3(0, 0, 0), groundMaterialPtr);
	AddGeometry(groundPtr);

	for (unsigned int z = 0; z < 100; z += 10)
	{
		for (unsigned int x = 0; x < 100; x += 10)
		{
			MaterialPtr sphereMaterialPtr;

#ifdef USE_OPENGL4			
			sphereMaterialPtr = new Material(mBumpedDiffuseShaderPtr);
#else
			sphereMaterialPtr = new Material();
#endif
			sphereMaterialPtr->SetTexture("colorMap", mTennisBallColorMapTexturePtr);
#ifdef USE_OPENGL4
			//spSphereMaterial->SetTexture("bumpMap", mTennisBallBumpMapTexture);
			sphereMaterialPtr->SetVec4("color", glm::vec4(1.0f, 1.0f, 1.0f, 1.0f));
#endif

			GeometryPtr spherePtr = StandardGeometries::CreateSphere(2.5f, 30, 30, sphereMaterialPtr);
			spherePtr->Translate(glm::vec3(-45.0f + x, 2.5f, -45.0f + z));
			AddGeometry(spherePtr);
		}
	}
}

TexturePtr BumpMappingApplication::LoadPNGAsTexture(const std::string& rFileName)
{
	unsigned int width;
	unsigned int height;
	bool transparency;
	unsigned char* pData;

	PNGLoader::Load(rFileName, &width, &height, &transparency, &pData);

	return new Texture(width, height, (transparency) ? TF_RGBA : TF_RGB, DT_UNSIGNED_CHAR, FM_BILINEAR, WM_CLAMP, pData);
}